name: Deploy GENESIS v4

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # ============ Build and Push Images ============
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest,${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest,${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.genesis-pj.net
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============ Deploy to VPS ============
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 10m
          envs: GITHUB_TOKEN,POSTGRES_PASSWORD,REDIS_PASSWORD,SECRET_KEY,TWITTER_CLIENT_ID,TWITTER_CLIENT_SECRET,CLAUDE_API_KEY,ACME_EMAIL,TRAEFIK_USERS,BACKEND_IMAGE,FRONTEND_IMAGE
          script: |
            set -e

            # Clone repo if doesn't exist
            if [ ! -d ~/genesis/.git ]; then
              rm -rf ~/genesis
              git clone https://x-access-token:${GITHUB_TOKEN}@github.com/Workwrite-Niidome/genesis.git ~/genesis
            fi

            cd ~/genesis

            # Pull latest code
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/Workwrite-Niidome/genesis.git
            git fetch origin master
            git reset --hard origin/master

            # Create .env file
            cat > .env << EOF
            POSTGRES_USER=genesis
            POSTGRES_DB=genesis
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            REDIS_PASSWORD=${REDIS_PASSWORD}
            SECRET_KEY=${SECRET_KEY}
            TWITTER_CLIENT_ID=${TWITTER_CLIENT_ID}
            TWITTER_CLIENT_SECRET=${TWITTER_CLIENT_SECRET}
            CLAUDE_API_KEY=${CLAUDE_API_KEY}
            ACME_EMAIL=${ACME_EMAIL}
            TRAEFIK_USERS=${TRAEFIK_USERS}
            BACKEND_IMAGE=${BACKEND_IMAGE}
            FRONTEND_IMAGE=${FRONTEND_IMAGE}
            EOF

            # Login to GHCR
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images
            docker pull ${BACKEND_IMAGE}:latest
            docker pull ${FRONTEND_IMAGE}:latest

            # Tag images for docker-compose
            docker tag ${BACKEND_IMAGE}:latest genesis-backend:latest
            docker tag ${FRONTEND_IMAGE}:latest genesis-frontend:latest

            # Restart services
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker compose -f docker-compose.prod.yml up -d

            # Wait for services
            sleep 15

            # Run migrations
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "Migration warning"

            # Show status
            docker compose -f docker-compose.prod.yml ps

            echo "Deployment complete!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          TWITTER_CLIENT_ID: ${{ secrets.TWITTER_CLIENT_ID }}
          TWITTER_CLIENT_SECRET: ${{ secrets.TWITTER_CLIENT_SECRET }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ACME_EMAIL: ${{ secrets.ACME_EMAIL }}
          TRAEFIK_USERS: ${{ secrets.TRAEFIK_USERS }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}

  # ============ Notify ============
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ GENESIS v4 deployed successfully to genesis-pj.net"
          else
            echo "❌ Deployment failed"
            exit 1
          fi
