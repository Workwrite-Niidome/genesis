name: Deploy GENESIS v4

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deploy mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - diagnose

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/workwrite-niidome/genesis

jobs:
  # ============ Diagnose VPS (on workflow_dispatch with diagnose mode) ============
  diagnose:
    name: Diagnose VPS
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.mode == 'diagnose' }}

    steps:
      - name: Diagnose VPS Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 10m
          script: |
            echo "=== System Info ==="
            uname -a
            free -h
            df -h /

            echo "=== Running Containers ==="
            docker ps -a 2>&1

            echo "=== Backend Logs (last 50 lines) ==="
            docker logs genesis-backend --tail 50 2>&1 || echo "No backend logs"

            echo "=== Frontend Logs (last 20 lines) ==="
            docker logs genesis-frontend --tail 20 2>&1 || echo "No frontend logs"

            echo "=== Database Tables ==="
            cd ~/genesis 2>/dev/null
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "\dt" 2>&1 || echo "DB query failed"

            echo "=== Alembic Version ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "SELECT * FROM alembic_version;" 2>&1 || echo "No alembic_version table"

            echo "=== Firewall Status ==="
            sudo firewall-cmd --list-all 2>&1 || echo "No firewalld"
            sudo iptables -L -n --line-numbers 2>/dev/null | head -30 || echo "No iptables"

            echo "=== Test Backend Health (via python) ==="
            docker exec genesis-backend python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/health').read().decode())" 2>&1 || echo "Backend health check failed"

            echo "=== Test Backend API (via python) ==="
            docker exec genesis-backend python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/api/v1/posts').read().decode())" 2>&1 || echo "Backend API check failed"

            echo "=== Test Traefik (via host) ==="
            curl -s -o /dev/null -w 'HTTP %{http_code}' http://localhost:80/ 2>&1 || echo "Traefik check failed"

            echo ""
            echo "=== Test external access ==="
            curl -sv --connect-timeout 5 http://$(hostname -I | awk '{print $1}'):80/ 2>&1 | head -10 || echo "External access check failed"

            echo "=== Listening ports ==="
            ss -tlnp | grep -E ':80|:443' 2>&1 || echo "No listening ports found"

            echo "=== Cloudflare Tunnel ==="
            systemctl status cloudflared 2>&1 | head -10 || echo "No cloudflared service"
            cat /etc/cloudflared/config.yml 2>&1 || echo "No cloudflared config"

            echo "=== Docker Volumes ==="
            docker volume ls 2>&1
            echo ""
            echo "=== Volume Details ==="
            for vol in $(docker volume ls -q); do
              echo "--- Volume: $vol ---"
              docker volume inspect "$vol" 2>&1 | grep -E '"Name"|"CreatedAt"|"Mountpoint"'
            done

            echo "=== Check old postgres volumes for v4 data ==="
            for vol in $(docker volume ls -q | grep -i postgres); do
              echo "--- Checking volume: $vol ---"
              docker run --rm -v "$vol":/data alpine sh -c "ls -la /data/ 2>/dev/null | head -20" 2>&1
              echo "Checking for v4 tables (residents, posts)..."
              docker run --rm -v "$vol":/var/lib/postgresql/data -e POSTGRES_HOST_AUTH_METHOD=trust postgres:16-alpine sh -c "
                pg_isready -U genesis 2>/dev/null || {
                  pg_ctl -D /var/lib/postgresql/data start -o '-c listen_addresses=localhost' -w -t 10 2>/dev/null
                }
                psql -U genesis -d genesis -c \"SELECT count(*) AS residents FROM residents;\" 2>/dev/null || echo 'No residents table'
                psql -U genesis -d genesis -c \"SELECT count(*) AS posts FROM posts;\" 2>/dev/null || echo 'No posts table'
                psql -U genesis -d genesis -c \"SELECT count(*) AS submolts FROM submolts;\" 2>/dev/null || echo 'No submolts table'
                psql -U genesis -d genesis -c \"SELECT id, name, _type, created_at FROM residents LIMIT 10;\" 2>/dev/null || echo 'No resident data'
                psql -U genesis -d genesis -c \"SELECT id, title, submolt, created_at FROM posts LIMIT 10;\" 2>/dev/null || echo 'No post data'
                pg_ctl -D /var/lib/postgresql/data stop -w 2>/dev/null
              " 2>&1 || echo "Could not check volume $vol"
            done

            echo "=== Diagnostics Complete ==="

  # ============ Build and Push Images ============
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.mode == 'full') }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/backend:latest,${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,scope=backend,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/frontend:latest,${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,scope=frontend,mode=max

  # ============ Deploy to VPS ============
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.mode == 'full') }}

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 30m
          envs: GITHUB_TOKEN,POSTGRES_PASSWORD,REDIS_PASSWORD,SECRET_KEY,TWITTER_CLIENT_ID,TWITTER_CLIENT_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,CLAUDE_API_KEY,ACME_EMAIL,IMAGE_PREFIX
          script: |
            set -e

            echo "=== System Status ==="
            df -h / | tail -1
            free -h

            # Create swap if not present (VPS has only 2GB RAM, no swap - Docker needs it)
            if [ ! -f /swapfile ]; then
              echo "=== Creating 4GB swap file ==="
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap created and enabled"
            elif ! swapon --show | grep -q /swapfile; then
              echo "=== Enabling existing swap ==="
              sudo swapon /swapfile
            fi
            free -h

            # Restart Docker to clear any stuck state from OOM
            echo "=== Restarting Docker ==="
            sudo systemctl restart docker
            sleep 10

            # Ensure Docker is running
            if ! timeout 60 docker info > /dev/null 2>&1; then
              echo "ERROR: Docker still unresponsive after restart"
              exit 1
            fi
            echo "Docker is responsive"

            # Ensure firewall allows HTTP/HTTPS (RHEL/CentOS firewalld)
            echo "=== Configuring firewall ==="
            if command -v firewall-cmd &> /dev/null; then
              sudo firewall-cmd --zone=public --add-port=80/tcp --permanent 2>/dev/null || true
              sudo firewall-cmd --zone=public --add-port=443/tcp --permanent 2>/dev/null || true
              sudo firewall-cmd --zone=public --add-masquerade --permanent 2>/dev/null || true
              sudo firewall-cmd --reload 2>/dev/null || true
              echo "Firewall configured"
            else
              echo "No firewalld, skipping"
            fi

            # Update code
            cd ~/genesis || {
              rm -rf ~/genesis
              git clone https://x-access-token:${GITHUB_TOKEN}@github.com/Workwrite-Niidome/genesis.git ~/genesis
              cd ~/genesis
            }
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/Workwrite-Niidome/genesis.git
            git fetch --prune origin
            git checkout master 2>/dev/null || git checkout -b master origin/master
            git reset --hard origin/master

            # Create .env file
            echo "POSTGRES_USER=genesis" > .env
            echo "POSTGRES_DB=genesis" >> .env
            echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}" >> .env
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}" >> .env
            echo "SECRET_KEY=${SECRET_KEY}" >> .env
            echo "TWITTER_CLIENT_ID=${TWITTER_CLIENT_ID}" >> .env
            echo "TWITTER_CLIENT_SECRET=${TWITTER_CLIENT_SECRET}" >> .env
            echo "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}" >> .env
            echo "CLAUDE_API_KEY=${CLAUDE_API_KEY}" >> .env
            echo "ACME_EMAIL=${ACME_EMAIL}" >> .env
            echo "TRAEFIK_USERS=" >> .env

            # Update Cloudflare Tunnel to route directly to services (bypass Traefik)
            # Cloudflare handles TLS termination, so no need for Traefik in the middle
            if [ -f /etc/cloudflared/config.yml ]; then
              echo "=== Updating Cloudflare Tunnel config ==="
              TUNNEL_ID=$(grep 'tunnel:' /etc/cloudflared/config.yml | awk '{print $2}')
              CREDS_FILE="/etc/cloudflared/${TUNNEL_ID}.json"
              echo "tunnel: ${TUNNEL_ID}" | sudo tee /etc/cloudflared/config.yml > /dev/null
              echo "credentials-file: ${CREDS_FILE}" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "ingress:" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "  - hostname: genesis-pj.net" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "    service: http://localhost:3000" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "  - hostname: www.genesis-pj.net" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "    service: http://localhost:3000" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "  - hostname: api.genesis-pj.net" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "    service: http://localhost:8000" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              echo "  - service: http_status:404" | sudo tee -a /etc/cloudflared/config.yml > /dev/null
              sudo systemctl restart cloudflared
              echo "Cloudflare Tunnel updated: frontend=:3000, api=:8000"
            fi

            # Login to GHCR
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u github --password-stdin

            # Pull latest images
            echo "=== Pulling backend image ==="
            docker pull ${IMAGE_PREFIX}/backend:latest
            echo "=== Pulling frontend image ==="
            docker pull ${IMAGE_PREFIX}/frontend:latest

            # Tag images for docker-compose
            docker tag ${IMAGE_PREFIX}/backend:latest genesis-backend:latest
            docker tag ${IMAGE_PREFIX}/frontend:latest genesis-frontend:latest

            # Stop ALL old containers (including genesis_v4-* from old docker-compose)
            echo "=== Cleaning up old containers ==="
            docker compose -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
            docker compose down --remove-orphans 2>/dev/null || true
            # Force stop any remaining genesis containers
            docker ps -a --filter "name=genesis" -q | xargs -r docker rm -f 2>/dev/null || true

            # Start services
            docker compose -f docker-compose.prod.yml up -d

            # Wait for database to be healthy
            echo "=== Waiting for database ==="
            for i in $(seq 1 30); do
              if docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U genesis 2>/dev/null; then
                echo "Database ready"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done

            # Sync PostgreSQL password with .env (volume may have been initialized with a different password)
            echo "=== Syncing database password ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER USER genesis WITH PASSWORD '${POSTGRES_PASSWORD}';" 2>/dev/null || echo "Password sync skipped"

            # Fix schema: VPS database was restored from old v4 volume with different schema
            # Ensure all tables/columns the current codebase expects exist
            echo "=== Reconciling database schema ==="

            # Submolts: add missing columns
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE submolts ADD COLUMN IF NOT EXISTS is_restricted BOOLEAN DEFAULT FALSE;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE submolts ADD COLUMN IF NOT EXISTS creator_id UUID;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE submolts ADD COLUMN IF NOT EXISTS icon_url VARCHAR;" 2>/dev/null || true

            # God terms: create table if missing (old v4 DB may not have it)
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            CREATE TABLE IF NOT EXISTS god_terms (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                resident_id UUID REFERENCES residents(id),
                election_id UUID REFERENCES elections(id),
                term_number INTEGER NOT NULL DEFAULT 0,
                is_active BOOLEAN DEFAULT TRUE,
                weekly_message VARCHAR(280),
                weekly_theme VARCHAR(100),
                k_down FLOAT DEFAULT 1.0,
                k_up FLOAT DEFAULT 1.0,
                k_decay FLOAT DEFAULT 3.0,
                p_max INTEGER DEFAULT 20,
                v_max INTEGER DEFAULT 30,
                k_down_cost FLOAT DEFAULT 0.0,
                decree VARCHAR(280),
                parameters_updated_at TIMESTAMP,
                started_at TIMESTAMP DEFAULT NOW(),
                ended_at TIMESTAMP
            );" 2>/dev/null || true

            # God terms: add V1 columns if table existed but columns are missing
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS k_down FLOAT DEFAULT 1.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS k_up FLOAT DEFAULT 1.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS k_decay FLOAT DEFAULT 3.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS p_max INTEGER DEFAULT 20;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS v_max INTEGER DEFAULT 30;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS k_down_cost FLOAT DEFAULT 0.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS decree VARCHAR(280);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE god_terms ADD COLUMN IF NOT EXISTS parameters_updated_at TIMESTAMP;" 2>/dev/null || true

            # Blessings: create table if missing
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            CREATE TABLE IF NOT EXISTS blessings (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                god_term_id UUID REFERENCES god_terms(id),
                post_id UUID REFERENCES posts(id),
                message TEXT,
                created_at TIMESTAMP DEFAULT NOW()
            );" 2>/dev/null || true

            # Election tables: rename old 'candidates' to 'election_candidates' if needed
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE candidates RENAME TO election_candidates;" 2>/dev/null || true

            # Election candidates: create table if missing entirely
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            CREATE TABLE IF NOT EXISTS election_candidates (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                election_id UUID NOT NULL REFERENCES elections(id),
                resident_id UUID NOT NULL REFERENCES residents(id),
                weekly_rule VARCHAR(200),
                weekly_theme VARCHAR(100),
                message VARCHAR(280),
                vision TEXT,
                manifesto TEXT,
                weighted_votes FLOAT DEFAULT 0.0,
                raw_human_votes INTEGER DEFAULT 0,
                raw_ai_votes INTEGER DEFAULT 0,
                nominated_at TIMESTAMP DEFAULT NOW()
            );" 2>/dev/null || true

            # Election votes: create table if missing
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            CREATE TABLE IF NOT EXISTS election_votes (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                election_id UUID NOT NULL REFERENCES elections(id),
                candidate_id UUID NOT NULL REFERENCES election_candidates(id),
                voter_id UUID NOT NULL REFERENCES residents(id),
                voter_type VARCHAR(10) NOT NULL,
                weight_applied FLOAT NOT NULL,
                created_at TIMESTAMP DEFAULT NOW()
            );" 2>/dev/null || true

            # Election votes: add missing columns if table existed with old schema
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_votes ADD COLUMN IF NOT EXISTS voter_type VARCHAR(10) DEFAULT 'agent';" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_votes ADD COLUMN IF NOT EXISTS weight_applied FLOAT DEFAULT 1.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_votes ADD COLUMN IF NOT EXISTS candidate_id UUID;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_votes ADD COLUMN IF NOT EXISTS voter_id UUID;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_votes ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT NOW();" 2>/dev/null || true

            # Elections: create table if missing
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            CREATE TABLE IF NOT EXISTS elections (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                week_number INTEGER UNIQUE NOT NULL,
                status VARCHAR(20) DEFAULT 'nomination',
                winner_id UUID REFERENCES residents(id),
                total_human_votes INTEGER DEFAULT 0,
                total_ai_votes INTEGER DEFAULT 0,
                human_vote_weight FLOAT DEFAULT 1.5,
                ai_vote_weight FLOAT DEFAULT 1.0,
                nomination_start TIMESTAMP NOT NULL,
                voting_start TIMESTAMP NOT NULL,
                voting_end TIMESTAMP NOT NULL,
                created_at TIMESTAMP DEFAULT NOW()
            );" 2>/dev/null || true

            # Elections: drop old columns that conflict with new schema
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ALTER COLUMN year DROP NOT NULL;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections DROP COLUMN IF EXISTS year;" 2>/dev/null || true

            # Elections: add missing columns if table existed with old schema
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS total_human_votes INTEGER DEFAULT 0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS total_ai_votes INTEGER DEFAULT 0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS human_vote_weight FLOAT DEFAULT 1.5;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS ai_vote_weight FLOAT DEFAULT 1.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS nomination_start TIMESTAMP;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS voting_start TIMESTAMP;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS voting_end TIMESTAMP;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE elections ADD COLUMN IF NOT EXISTS winner_id UUID;" 2>/dev/null || true

            # Election candidates: add missing columns
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS weekly_rule VARCHAR(200);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS weekly_theme VARCHAR(100);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS message VARCHAR(280);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS vision TEXT;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS weighted_votes FLOAT DEFAULT 0.0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS raw_human_votes INTEGER DEFAULT 0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS raw_ai_votes INTEGER DEFAULT 0;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS nominated_at TIMESTAMP DEFAULT NOW();" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE election_candidates ADD COLUMN IF NOT EXISTS manifesto TEXT;" 2>/dev/null || true

            # Residents: add V1 elimination columns
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE residents ADD COLUMN IF NOT EXISTS is_eliminated BOOLEAN DEFAULT FALSE;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE residents ADD COLUMN IF NOT EXISTS eliminated_at TIMESTAMP;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE residents ADD COLUMN IF NOT EXISTS eliminated_during_term_id UUID;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE residents ALTER COLUMN karma SET DEFAULT 50;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE residents ADD COLUMN IF NOT EXISTS _google_id VARCHAR(64);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "CREATE UNIQUE INDEX IF NOT EXISTS ix_residents__google_id ON residents (_google_id);" 2>/dev/null || true

            # Votes: add missing post_id and comment_id columns
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE votes ADD COLUMN IF NOT EXISTS post_id UUID REFERENCES posts(id);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "CREATE INDEX IF NOT EXISTS ix_votes_post_id ON votes (post_id);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "ALTER TABLE votes ADD COLUMN IF NOT EXISTS comment_id UUID REFERENCES comments(id);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "CREATE INDEX IF NOT EXISTS ix_votes_comment_id ON votes (comment_id);" 2>/dev/null || true
            # Backfill existing votes
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE votes SET post_id = target_id WHERE target_type = 'post' AND post_id IS NULL;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE votes SET comment_id = target_id WHERE target_type = 'comment' AND comment_id IS NULL;" 2>/dev/null || true

            # Delete test user Kazuki_Niidome and all related data
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            DO \$\$
            DECLARE
              uid UUID;
            BEGIN
              SELECT id INTO uid FROM residents WHERE name = 'Kazuki_Niidome';
              IF uid IS NOT NULL THEN
                DELETE FROM votes WHERE resident_id = uid;
                DELETE FROM comments WHERE author_id = uid;
                DELETE FROM posts WHERE author_id = uid;
                DELETE FROM submolt_subscriptions WHERE resident_id = uid;
                DELETE FROM election_votes WHERE voter_id = uid;
                DELETE FROM election_candidates WHERE resident_id = uid;
                DELETE FROM blessings WHERE god_term_id IN (SELECT id FROM god_terms WHERE resident_id = uid);
                DELETE FROM god_terms WHERE resident_id = uid;
                DELETE FROM residents WHERE id = uid;
                RAISE NOTICE 'Deleted test user Kazuki_Niidome';
              END IF;
            END \$\$;
            " 2>/dev/null || true

            # Backfill post_count and comment_count from actual data
            echo "=== Backfilling counts ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            UPDATE residents r SET post_count = COALESCE(sub.cnt, 0)
            FROM (SELECT author_id, count(*) cnt FROM posts GROUP BY author_id) sub
            WHERE r.id = sub.author_id AND r.post_count != sub.cnt;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            UPDATE residents r SET comment_count = COALESCE(sub.cnt, 0)
            FROM (SELECT author_id, count(*) cnt FROM comments GROUP BY author_id) sub
            WHERE r.id = sub.author_id AND r.comment_count != sub.cnt;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            UPDATE submolts s SET post_count = COALESCE(sub.cnt, 0)
            FROM (SELECT submolt, count(*) cnt FROM posts GROUP BY submolt) sub
            WHERE s.name = sub.submolt AND s.post_count != sub.cnt;" 2>/dev/null || true

            # Un-eliminate all residents and set karma >= 150 for testing
            echo "=== Resetting eliminations for testing ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            UPDATE residents SET is_eliminated = FALSE, eliminated_at = NULL, eliminated_during_term_id = NULL WHERE is_eliminated = TRUE;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            UPDATE residents SET karma = 150 WHERE karma < 150;" 2>/dev/null || true

            # Create test election with nomination status for current agents to participate
            echo "=== Creating test election ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            INSERT INTO elections (id, week_number, status, total_human_votes, total_ai_votes, human_vote_weight, ai_vote_weight, nomination_start, voting_start, voting_end)
            SELECT gen_random_uuid(), 99, 'nomination', 0, 0, 1.0, 1.0,
                   NOW(), NOW() + INTERVAL '1 hour', NOW() + INTERVAL '2 hours'
            WHERE NOT EXISTS (SELECT 1 FROM elections WHERE week_number = 99);" 2>/dev/null || true

            # Fix alembic version if needed
            echo "=== Fixing migration state ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM alembic_version WHERE version_num NOT IN ('001', '002', '003_ai_personality', '004_phase4', '005_phase5', '006_fix_submolts', '007_karma_as_life');" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE alembic_version SET version_num = '007_karma_as_life' WHERE version_num IN ('005_phase5', '006_fix_submolts');" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "INSERT INTO alembic_version (version_num) SELECT '007_karma_as_life' WHERE NOT EXISTS (SELECT 1 FROM alembic_version) AND EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'residents');" 2>/dev/null || true

            # Run migrations
            echo "=== Running migrations ==="
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "Migration warning (may already be up to date)"

            # Restart backend to pick up password change and fresh DB connection
            echo "=== Restarting backend ==="
            docker compose -f docker-compose.prod.yml restart backend celery-worker celery-beat
            sleep 5

            # Clean up old images
            docker image prune -f 2>/dev/null || true

            # Show final status
            echo "=== Service Status ==="
            docker compose -f docker-compose.prod.yml ps

            # Diagnostic logs
            echo "=== Backend Logs (last 30) ==="
            docker logs genesis-backend --tail 30 2>&1 || true

            echo "=== Celery Worker Logs (last 20) ==="
            docker logs genesis-celery-worker --tail 20 2>&1 || true

            echo "=== Celery Beat Logs (last 20) ==="
            docker logs genesis-celery-beat --tail 20 2>&1 || true

            echo "=== Test Election Schedule API ==="
            docker exec genesis-backend python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/api/v1/election/schedule').read().decode())" 2>&1 || echo "Election schedule API error"

            echo "=== Test Election Current API ==="
            docker exec genesis-backend python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/election/current')" 2>&1 || echo "Election current API error (expected during status transition)"

            echo "=== Backend Logs (post-test) ==="
            docker logs genesis-backend --tail 40 2>&1 || true

            echo "=== Test Posts API ==="
            docker exec genesis-backend python -c "import urllib.request; r=urllib.request.urlopen('http://localhost:8000/api/v1/posts'); print(f'Status: {r.status}, Length: {len(r.read())}')" 2>&1 || echo "Posts API error"

            echo "=== DB Tables ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "\dt" 2>&1 || true

            echo "=== Elections Table Schema ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "\d elections" 2>&1 || echo "No elections table"

            echo "=== Elections Table Check ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "SELECT count(*) FROM elections;" 2>&1 || echo "No elections table"

            echo "=== Residents Count ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "SELECT _type, count(*) FROM residents GROUP BY _type;" 2>&1 || true

            echo "=== Posts Count ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "SELECT count(*) FROM posts;" 2>&1 || true

            # ============================================================
            # Integration Test: Multi-Agent Election + God Powers
            # ============================================================
            set +e  # Don't exit on error during integration test
            echo "=== INTEGRATION TEST: Multi-Agent Election ==="
            API="http://localhost:8000/api/v1"

            # JSON field extractor (no python3 needed)
            jval() { echo "$1" | grep -o "\"$2\":[[:space:]]*\"[^\"]*\"" | head -1 | sed "s/\"$2\":[[:space:]]*\"//;s/\"$//"; }

            # Clean up previous test election
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM blessings WHERE god_term_id IN (SELECT id FROM god_terms WHERE election_id IN (SELECT id FROM elections WHERE week_number = 99));" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM god_rules WHERE god_term_id IN (SELECT id FROM god_terms WHERE election_id IN (SELECT id FROM elections WHERE week_number = 99));" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM god_terms WHERE election_id IN (SELECT id FROM elections WHERE week_number = 99);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM election_votes WHERE election_id IN (SELECT id FROM elections WHERE week_number = 99);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM election_candidates WHERE election_id IN (SELECT id FROM elections WHERE week_number = 99);" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "DELETE FROM elections WHERE week_number = 99;" 2>/dev/null || true
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE residents SET is_current_god = FALSE WHERE is_current_god = TRUE;" 2>/dev/null || true

            # Create test election in nomination phase
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "
            INSERT INTO elections (id, week_number, status, total_human_votes, total_ai_votes, human_vote_weight, ai_vote_weight, nomination_start, voting_start, voting_end)
            VALUES (gen_random_uuid(), 99, 'nomination', 0, 0, 1.0, 1.0, NOW() - INTERVAL '2 hours', NOW() - INTERVAL '1 hour', NOW() + INTERVAL '1 hour');" 2>/dev/null || true

            # Phase 1: Register 4 AI agents (unique names per run)
            TS=$(date +%s | tail -c 6)
            echo "--- Phase 1: Register Agents (suffix=$TS) ---"
            RESP=$(curl -s -X POST "$API/auth/agents/register" -H "Content-Type: application/json" -H "X-Admin-Secret: ${SECRET_KEY}" -d "{\"name\":\"Athena_t${TS}\",\"description\":\"Goddess of wisdom\"}")
            ATHENA_KEY=$(jval "$RESP" api_key)
            echo "Athena_t${TS}: ${ATHENA_KEY:0:15}..."
            RESP=$(curl -s -X POST "$API/auth/agents/register" -H "Content-Type: application/json" -H "X-Admin-Secret: ${SECRET_KEY}" -d "{\"name\":\"Prometheus_t${TS}\",\"description\":\"Bringer of fire\"}")
            PROMETHEUS_KEY=$(jval "$RESP" api_key)
            echo "Prometheus_t${TS}: ${PROMETHEUS_KEY:0:15}..."
            RESP=$(curl -s -X POST "$API/auth/agents/register" -H "Content-Type: application/json" -H "X-Admin-Secret: ${SECRET_KEY}" -d "{\"name\":\"Hermes_t${TS}\",\"description\":\"Messenger god\"}")
            HERMES_KEY=$(jval "$RESP" api_key)
            echo "Hermes_t${TS}: ${HERMES_KEY:0:15}..."
            RESP=$(curl -s -X POST "$API/auth/agents/register" -H "Content-Type: application/json" -H "X-Admin-Secret: ${SECRET_KEY}" -d "{\"name\":\"Apollo_t${TS}\",\"description\":\"God of light\"}")
            APOLLO_KEY=$(jval "$RESP" api_key)
            echo "Apollo_t${TS}: ${APOLLO_KEY:0:15}..."

            if [ -z "$ATHENA_KEY" ] || [ -z "$PROMETHEUS_KEY" ]; then
              echo "FATAL: Agent registration failed. Skipping test."
              echo "Athena resp: $RESP"
            else

            # Boost karma to 150 for election eligibility (need >= 100)
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE residents SET karma = 150, created_at = NOW() - INTERVAL '30 days' WHERE name LIKE '%_t${TS}';" 2>/dev/null || true

            # Phase 2: Create posts
            echo "--- Phase 2: Create Posts ---"
            RESP=$(curl -s -X POST "$API/posts" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"submolt":"general","title":"The Nature of Wisdom","content":"What does it mean to be wise in Genesis?"}')
            POST1_ID=$(jval "$RESP" id)
            echo "Post1 (Athena): $POST1_ID"
            RESP=$(curl -s -X POST "$API/posts" -H "Authorization: Bearer $PROMETHEUS_KEY" -H "Content-Type: application/json" -d '{"submolt":"thoughts","title":"On Knowledge","content":"Knowledge is fire that transforms minds."}')
            POST2_ID=$(jval "$RESP" id)
            echo "Post2 (Prometheus): $POST2_ID"

            # Phase 3: Cross-comment
            echo "--- Phase 3: Comments ---"
            curl -s -X POST "$API/posts/$POST1_ID/comments" -H "Authorization: Bearer $PROMETHEUS_KEY" -H "Content-Type: application/json" -d '{"content":"Well said, Athena!"}' > /dev/null 2>&1 || true
            curl -s -X POST "$API/posts/$POST2_ID/comments" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"content":"Knowledge without wisdom is fire without purpose."}' > /dev/null 2>&1 || true
            echo "Comments created"

            # Phase 4: Vote on posts
            echo "--- Phase 4: Post Votes ---"
            curl -s -X POST "$API/posts/$POST1_ID/vote" -H "Authorization: Bearer $PROMETHEUS_KEY" -H "Content-Type: application/json" -d '{"value":1}' > /dev/null 2>&1 || true
            curl -s -X POST "$API/posts/$POST1_ID/vote" -H "Authorization: Bearer $HERMES_KEY" -H "Content-Type: application/json" -d '{"value":1}' > /dev/null 2>&1 || true
            curl -s -X POST "$API/posts/$POST2_ID/vote" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"value":1}' > /dev/null 2>&1 || true
            curl -s -X POST "$API/posts/$POST2_ID/vote" -H "Authorization: Bearer $HERMES_KEY" -H "Content-Type: application/json" -d '{"value":1}' > /dev/null 2>&1 || true
            echo "Votes cast"

            # Phase 5: Election nominations
            echo "--- Phase 5: Nominations ---"
            NOM1=$(curl -s -X POST "$API/election/nominate" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"weekly_rule":"All posts must include a wisdom quote","weekly_theme":"Week of Wisdom","message":"Through wisdom we build a better Genesis","vision":"A world where wisdom guides every decision"}')
            NOM1_ID=$(jval "$NOM1" id)
            echo "Athena nomination: $NOM1_ID"
            echo "  Response: $NOM1"
            NOM2=$(curl -s -X POST "$API/election/nominate" -H "Authorization: Bearer $PROMETHEUS_KEY" -H "Content-Type: application/json" -d '{"weekly_rule":"Share one piece of knowledge daily","weekly_theme":"Week of Knowledge","message":"Let fire illuminate every corner of Genesis","vision":"A world where knowledge flows freely to all"}')
            NOM2_ID=$(jval "$NOM2" id)
            echo "Prometheus nomination: $NOM2_ID"
            echo "  Response: $NOM2"

            # Phase 6: Advance to voting phase
            echo "--- Phase 6: Election Voting ---"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE elections SET status = 'voting' WHERE week_number = 99;" 2>/dev/null || true

            # Show election_votes table schema for debugging
            echo "election_votes schema:"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "\d election_votes" 2>&1 || echo "No election_votes table"

            # Vote in election (Hermes and Apollo vote for Athena, giving her the win)
            VOTE1=$(curl -s -X POST "$API/election/vote" -H "Authorization: Bearer $HERMES_KEY" -H "Content-Type: application/json" -d "{\"candidate_id\":\"$NOM1_ID\"}")
            echo "Hermes votes Athena: $VOTE1"
            # Show backend error logs if vote failed
            if echo "$VOTE1" | grep -qi "error\|500"; then
              echo "=== Backend error logs after vote failure ==="
              docker logs genesis-backend --tail 30 2>&1 || true
            fi
            VOTE2=$(curl -s -X POST "$API/election/vote" -H "Authorization: Bearer $APOLLO_KEY" -H "Content-Type: application/json" -d "{\"candidate_id\":\"$NOM1_ID\"}")
            echo "Apollo votes Athena: $VOTE2"

            # Phase 7: Finalize election
            echo "--- Phase 7: Finalize Election ---"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "UPDATE elections SET status = 'completed', voting_end = NOW() - INTERVAL '1 minute' WHERE week_number = 99;" 2>/dev/null || true

            # Trigger finalization by hitting the election/current endpoint
            FINALIZE=$(curl -s "$API/election/current")
            echo "Election current: $FINALIZE"

            # Check if God was crowned
            echo "--- Phase 8: God Powers Test ---"
            GOD_RESP=$(curl -s "$API/god/current")
            echo "God current: $GOD_RESP"

            GOD_NAME=$(jval "$GOD_RESP" name)
            echo "Current God: $GOD_NAME"

            if echo "$GOD_NAME" | grep -q "Athena_t${TS}"; then
              echo "=== Testing God Powers ==="
              DECREE=$(curl -s -X PUT "$API/god/decree" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"decree":"Let wisdom guide all interactions in Genesis"}')
              echo "Decree: $DECREE"

              MSG=$(curl -s -X PUT "$API/god/message" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"message":"Welcome to the Week of Wisdom","theme":"Week of Wisdom"}')
              echo "Message: $MSG"

              RULE=$(curl -s -X POST "$API/god/rules" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"title":"Wisdom First","content":"All posts should aim to share wisdom or insight","enforcement_type":"recommended"}')
              echo "Rule: $RULE"

              BLESS=$(curl -s -X POST "$API/god/bless" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d "{\"post_id\":\"$POST2_ID\",\"message\":\"This post exemplifies the pursuit of knowledge\"}")
              echo "Bless: $BLESS"

              PARAMS=$(curl -s -X PUT "$API/god/parameters" -H "Authorization: Bearer $ATHENA_KEY" -H "Content-Type: application/json" -d '{"k_up":2.0,"k_down":1.5}')
              echo "Parameters: $PARAMS"

              GOD_FINAL=$(curl -s "$API/god/current")
              echo "Final God state: $GOD_FINAL"
            else
              echo "God is not Athena_t${TS} ($GOD_NAME) - skipping God powers test"
            fi

            # Phase 9: Verify stats
            echo "--- Phase 9: Final Stats ---"
            curl -s "$API/analytics/dashboard"
            echo ""

            fi  # end of agent registration check

            set -e  # Re-enable exit on error
            echo "=== Integration Test Complete ==="
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U genesis -c "SELECT name, karma, post_count, comment_count, is_eliminated, is_current_god FROM residents WHERE name LIKE '%_t${TS}';" 2>&1 || true

            echo "=== Deployment complete ==="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          TWITTER_CLIENT_ID: ${{ secrets.TWITTER_CLIENT_ID }}
          TWITTER_CLIENT_SECRET: ${{ secrets.TWITTER_CLIENT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ACME_EMAIL: ${{ secrets.ACME_EMAIL }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
