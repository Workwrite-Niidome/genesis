name: Cloudflare Cache Purge & Domain Setup

on:
  workflow_dispatch:

jobs:
  purge-and-verify:
    name: Purge cache and verify deployment
    runs-on: ubuntu-latest
    steps:
      - name: Get Zone ID for genesis-pj.net
        id: zone
        run: |
          ZONE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/zones?name=genesis-pj.net" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          ZONE_ID=$(echo "$ZONE" | jq -r '.result[0].id')
          echo "zone_id=$ZONE_ID" >> "$GITHUB_OUTPUT"
          echo "Zone ID: $ZONE_ID"

      - name: Purge ALL Cloudflare cache
        run: |
          echo "=== Purging all cache for genesis-pj.net ==="
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/zones/${{ steps.zone.outputs.zone_id }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"purge_everything": true}' | jq .

      - name: Wait for propagation
        run: sleep 15

      - name: Verify deployment content
        run: |
          echo "=== Checking genesis-pj.net ==="
          HTML=$(curl -s https://genesis-pj.net)
          JS_FILE=$(echo "$HTML" | grep -o 'index-[A-Za-z0-9]*\.js')
          echo "JS bundle: $JS_FILE"

          echo ""
          echo "=== Checking genesis-frontend-eua.pages.dev ==="
          HTML2=$(curl -s https://genesis-frontend-eua.pages.dev)
          JS_FILE2=$(echo "$HTML2" | grep -o 'index-[A-Za-z0-9]*\.js')
          echo "JS bundle: $JS_FILE2"

          if [ "$JS_FILE" = "$JS_FILE2" ]; then
            echo ""
            echo "✅ Both URLs serve the same bundle: $JS_FILE"
          else
            echo ""
            echo "⚠️ MISMATCH: genesis-pj.net=$JS_FILE vs pages.dev=$JS_FILE2"
          fi

      - name: Show Pages project details
        run: |
          echo "=== Pages project info ==="
          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/genesis-frontend" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" | jq '{
              name: .result.name,
              subdomain: .result.subdomain,
              production_branch: .result.production_branch,
              domains: .result.domains,
              latest_deployment: .result.latest_deployment.url,
              latest_deployment_branch: .result.latest_deployment.deployment_trigger.metadata.branch
            }'
